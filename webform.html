<!doctype html>

<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
    <script type="text/javascript" src="lib/axios/dist/axios.standalone.js"></script>
    <script type="text/javascript" src="lib/CryptoJS/rollups/hmac-sha256.js"></script>
    <script type="text/javascript" src="lib/CryptoJS/rollups/sha256.js"></script>
    <script type="text/javascript" src="lib/CryptoJS/components/hmac.js"></script>
    <script type="text/javascript" src="lib/CryptoJS/components/enc-base64.js"></script>
    <script type="text/javascript" src="lib/url-template/url-template.js"></script>
    <script type="text/javascript" src="lib/apiGatewayCore/sigV4Client.js"></script>
    <script type="text/javascript" src="lib/apiGatewayCore/apiGatewayClient.js"></script>
    <script type="text/javascript" src="lib/apiGatewayCore/simpleHttpClient.js"></script>
    <script type="text/javascript" src="lib/apiGatewayCore/utils.js"></script>
    <script type="text/javascript" src="apigClient.js"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
    <!--- Beginning of Stylesheet -->
    <style type="text/css">
        body {
            font-family: Sans-serif;
        }
        #rc-header {
            text-align: center;
            font-size: 40px;
            font-family: Sans-serif;
        }
        #form-outlook {
            padding-top: 15px;
            font-family: Sans-serif;
        }
        .form-design {
            width: 50%;
            height: 25px;
        }
        .form-element {
            padding: 20px;
            text-align: center;
        }
        .label-design {
            padding: 10px;
            display: inline-block;
            width: 30%;
        }
        #form-S {
            border: 3px solid black;
            width: 50%;
            text-align: center;
            display: block;
            margin-left: auto;
            margin-right: auto;
            background-color: #D3D3D3;
        }
        #submitButton1 {
            padding-bottom: 35px;
        }
        #submitButton {
            height: 40px;
            width: 50%;
        }
    </style>
    <!-- END OF STYLE SHEET -->

    <script type="text/javascript">


        const client_id = "nfm3pqn7899pnc4mkomangdeb"; //client ID of Cognito App Client
        console.log("starting auth");

    window.onload = function() {
        checkIfTokenExists();
    }

    function checkIfTokenExists(){
        //Check to see if JWT is in storage
        console.log(sessionStorage.getItem('token'));
        if(sessionStorage.getItem('token') == false || sessionStorage.getItem('token') == null){
            console.log("tokens dont exist");
            if(window.location.href.indexOf("token=") > -1){
                decodeIdtoken();
                console.log("now retrieved tokens")
            }else{
                console.log("no token to be found, redirecting back to login");
                window.location.href = "signin.html";
            }
        }else{
            console.log("tokens are here!");
            //getUserAttributes();
            let fullToken = decodeIdtoken();
            var tokenResult = fullToken[1];
            var username = tokenResult['cognito:username'];
            var profile = tokenResult["profile"];
            var site = tokenResult["custom:site"];
            var dshift = tokenResult["custom:DayShift"];
            var wshift = tokenResult["custom:WeekShift"]

            document.getElementById("alias").value = username;
            document.getElementById("PS-Profile").value = profile;
            document.getElementById("site").value = site;
            document.getElementById("w-shift").value = wshift;
            document.getElementById("d-shift").value = dshift;
    } 
}
    
    function decodeIdtoken() {
        //grabbing full jwt from url
        let code = window.location.search;
        //splitting url into 2 parts, [0] being url, [1] jwt
        let codeNum = code.split("=");
        let fullJWT = codeNum[1];
        let splitJWTtoID = fullJWT.split('.')[3];
        let splitJWTtoAccess = fullJWT.split('.')[1];
        let splitJWTtoRefresh = fullJWT.split('.')[0];
        let base64 = splitJWTtoID.replace('-', '+').replace('_', '/');
        var tokenResult = JSON.parse(window.atob(base64));
        console.log(tokenResult);
        console.log(splitJWTtoID);
        sessionStorage.setItem('token', JSON.stringify(splitJWTtoID));
        return [splitJWTtoID, tokenResult];
    }   
      
    //takes the decoded ID toke, and parses it to extract user attribute values 
    function getUserAttributes(){
        let fullToken = decodeIdtoken();
        var tokenResult = fullToken[1];
        var username = tokenResult['cognito:username'];
        var profile = tokenResult["profile"];
        var site = tokenResult["custom:site"];
        var dshift = tokenResult["custom:DayShift"];
        var wshift = tokenResult["custom:WeekShift"]

        document.getElementById("alias").value = username;
        document.getElementById("PS-Profile").value = profile;
        document.getElementById("site").value = site;
        document.getElementById("w-shift").value = wshift;
        document.getElementById("d-shift").value = dshift;

    }

        //validation to see if any fields have been left blank
        function checkIfEmpty() {
            var letters = /^[A-Za-z]+$/;
            if (
                document.getElementById('alias').value == "" ||
                document.getElementById('PS-Profile').value == "" ||
                document.getElementById('Request-Reason').value == "" ||
                document.getElementById('Request-Type').value == "" ||
                document.getElementById('w-shift').value == "" ||
                document.getElementById('startdate').value == "" ||
                document.getElementById('Duration').value == ""
            ) {
                alert("Please Fill All Required Fields");
                return false;
            } else {
                return true;
            }
        }
        //ensures for the Alias field, only text can be added as AWS Alias only contail text
        function onlyText() {
            var letters = /^[A-Za-z]+$/;
            if (document.getElementById('alias').value.match(letters)) {
                return true;
            } else {
                alert("your alias can only contain letters!");
                return false;
            }
        }
        //encodes the text field request-reason to prevent escape characters breaking the app
        function encStr(){
            var userString = document.getElementById("Request-Reason").value;
            var encodeString = encodeURIComponent(userString);
            encodeString.replace('\n', '%0A');
            return encodeString;
        }
        //validation to ensure the date entered is reasonable (no more than +1 year or -1 year)
        function validDate() {
            var newDateFormat = dateFormat();
            var d1 = newDateFormat.split("/");
            if (d1[2] > (new Date().getFullYear() + 1) || d1[2] < (new Date().getFullYear() - 1)) {
                alert("Please ensure date selected falls within 1 year of the current date");
                return false;
            } else {
                return true;
            }
        }
        //validation to ensure the duration field is a positive number and only accepts a whole or half number
        function validDuration() {
            if (document.getElementById("Duration").value % 1 == 0 && document.getElementById("Duration").value >= 0.5) {
                return true;
            } else {
                if (document.getElementById("Duration").value % 1 == 0.5) {
                    return true;
                } else {
                    alert("Duration can only be a full or half days");
                    return false;
                }
            }
        }
        //rearranges the format to dd//mm//yyyy
        function dateFormat() {
            var oldDate = new Date(document.getElementById("startdate").value);
            var month = oldDate.getMonth() + 1;
            var day = oldDate.getDate();
            var year = oldDate.getFullYear();
            var newDate = day + "/" + month + "/" + year;
            return newDate;
        }

        //Checks to see if the above validation functions are true, and if so, call apigw client to send form data
        function execute() {
            var newDateFormat = dateFormat();
            var encText = encStr();
            if (checkIfEmpty() && onlyText() && validDate() && validDuration()  == true) {
                var json = {
                    user: document.getElementById("alias").value,
                    psprofile: document.getElementById("PS-Profile").value,
                    requestType: document.getElementById("Request-Type").value,
                    shift: document.getElementById("w-shift").value,
                    dayShift: document.getElementById("d-shift").value,
                    startdate: newDateFormat,
                    Duration: document.getElementById("Duration").value,
                    RequestReason : encText,
                    Site: document.getElementById("site").value
                }
                var jsonText = JSON.stringify(json, null, 4);
                console.log(jsonText)
                callAPIGW(jsonText);  
            }else{
                console.log("Failed due to validation error");
            }
  
        }

        //if form submission is sucessful, display submitted data
        function confirmationMessage(){

            let site = document.getElementById("site").value;
            let dayShift = document.getElementById("d-shift").value;

            var confmsg = " <div style='text-align: center;'><h2>Confirmation of Request</h2></div>\
                            <div style='text-align: center;'><p style='display:inline'>User: </p>" + document.getElementById("alias").value + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>PS Profile: </p>" + document.getElementById("PS-Profile").value + " (" + site + ")" + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>Request Type: </p>" + document.getElementById("Request-Type").value + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>Shift: </p> " + document.getElementById("w-shift").value + " (" + dayShift + ")" + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>Start Date: </p>" + dateFormat() + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>Duration: </p>" + document.getElementById("Duration").value + "</div>\
                            <div style='text-align: center;'><p style='display:inline'>Request Reason: </p>" + document.getElementById("Request-Reason").value + "</div>\
                            <br/><br/>\
                            <div><button value='SubmitRequest!'onClick='window.location.reload()'>Submit Another Request!</button></div>";
            return confmsg;

        }

        function callAPIGW(newJson) { 
            var jsonToPass = newJson
            var apigClient = apigClientFactory.newClient();
            var params = {
            };
            var body = jsonToPass;
            var additionalParams = {
            }
        //call to API Gateway client to send data to Lambda
            if(apigClient.formsubmissionPost(params, body, additionalParams)){
                    console.log("success!");
                    document.getElementById("messageFailure").style.display="none";
                    document.getElementById("messageSuccess").style.display="block";
                    document.getElementById("form-S").style.display="none";
                    document.getElementById("messageSuccess").innerHTML = confirmationMessage();
                }else{
                    console.log("failure");  
                    document.getElementById("messageFailure").style.display="block";
                    document.getElementById("messageSuccess").style.display="none";
                    document.getElementById("form-S").style.display="block";
                }
            }  

    </script>

</head>
<body>
    <script type="text/javascript">
    (function() {
        if (window.localStorage) {
            if (!localStorage.getItem('firstLoad')) {
                localStorage['firstLoad'] = true;
                console.log("inside bottom script")
                window.location.reload();
            } else
                localStorage.removeItem('firstLoad');
            console.log("inside bottom script, second part")
        }
    })();
</script>
    <div>
        <h1 id="error"></h1>
        <h1 id="success"></h1>
    </div>
    <div id='redirect' style="display: none;">
        Redirecting...
        If this does not refresh in 5 seconds, please click <a href="signin.html">here</a>
    </div>
    <!-- Main Container contents -->
    <h1 id='rc-header' style="display: block" align="center">Roll Call App</h1>

    <!-- Start of form -->
    <div id="messageSuccess" style="display:none;" align="center">

    </div>
    <div id="messageFailure" style="display:none;">Something is going wrong :(</div>
    <div id='form-S' style="display:block;" class="container">
        <div class="form-element">
            <label for="userAlias" value="" class="label-design">User:</label>
            <input type="text" class="form-design" value="" name="User" id="alias" disabled="">
        </div>
        <div class="form-element">
            <label for="sel1" class="label-design">PS Profile:</label>
            <input type="text" class="form-design" value="" name="User" id="PS-Profile" disabled="">
        </div>
        <div class="form-element">
            <label for="sel1" class="label-design">Request Type:</label>
            <select class="form-design" name="Request-Type" required="required" id="Request-Type">
                <option value="" disabled selected id="dis">Select your option</option>
                <option>Holiday</option>
                <option>Sick</option>
                <option>Training Day</option>
                <option>AWS Events</option>
                <option>Other - Specify Below</option>
            </select>
        </div>
        <div>
            <label for="sel1" class="label-design">My Shift:</label>
            <input type="text" class="form-design" value="" name="User" id="w-shift" disabled="" style="width: 150px"><input type="text" class="form-design" value="" name="User" id="d-shift" disabled="" style="width: 150px; padding-left: 15px">
        </div>
        <div class="form-element">
            <label for="StartDate:" class="label-design">Start Date: (MM/DD/YYYY)</label>
            <input id="startdate" type="date" name="Start-Date" data-date-format="DD/MM/YYYY" placeholder="DD-MM-YYYY" class="form-design"></input>
        </div>
        <div class="form-element">
            <label for="No-Days:" class="label-design">Duration:</label>
            <input type="number" class="form-design" placeholder="Duration" name="No-Days" required="required" id="Duration">
        </div>
        <div class="form-element">
            <label for="RequestReason:" class="label-design">Request Reason:</label>
            <textarea rows="10" name="Request-Reason" id="Request-Reason" required="required" style="width: 50%"></textarea>
        </div>
        <div class="form-element">
            <input type="hidden" id="site" value="" />
        </div>
        <div id="submitButton1">
            <button id="submitButton" onClick="execute(); encStr();">Submit</button>
        </div>
    </div>
    </div>
    </div>
 </body>

</html>